<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8">
  <title>InAIR ¬∑ Reporte t√©cnico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background: #f7f7fb
    }

    .card {
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, .06)
    }

    .section-title {
      font-weight: 700;
      font-size: 1.05rem
    }

    .sig-box {
      background: #fff;
      border: 1px solid #e6e6e6;
      border-radius: 10px
    }

    .table-sm td,
    .table-sm th {
      padding: .35rem .5rem;
      font-size: .9rem
    }

    .grid-compact input {
      height: 32px;
    }

    .sticky-title {
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 2
    }

    /* ====== MEJORAS EN M√ìVIL ====== */
    @media (max-width: 576px) {
      body {
        background: #fff;
      }

      .card {
        border-radius: 12px;
        box-shadow: none;
      }

      /* Filas de ‚ÄúLecturas‚Äù: apila etiqueta y campos */
      .row.align-items-center>.col-8,
      .row.align-items-center>.col-4 {
        flex: 0 0 100%;
        max-width: 100%;
      }

      .row.align-items-center {
        margin-bottom: .35rem;
      }

      /* Inputs compactos */
      .form-control,
      .form-select {
        height: 38px;
        padding: .35rem .5rem;
      }

      .form-control.form-control-sm,
      .form-select.form-select-sm {
        height: 34px;
      }

      /* Tablas con scroll horizontal suave */
      .table-responsive {
        -webkit-overflow-scrolling: touch;
      }

      /* Firma m√°s alta en m√≥vil */
      .sig-box canvas {
        height: 160px !important;
      }
    }

    /* Evita que celdas/inputs se ‚Äúaplasten‚Äù en tablet */
    @media (min-width: 577px) and (max-width: 992px) {

      .form-control,
      .form-select {
        height: 40px;
      }
    }
  </style>
</head>

<body>
  <div class="container py-4">
    <div class="card p-3 mb-4">
      <div class="d-flex align-items-center justify-content-between gap-3">
        <div class="d-flex align-items-center gap-3">
          <img src="{{ url_for('static', filename='img/logo_inair.png') }}" alt="InAIR" style="height:40px">
          <div>
            <div class="fw-bold">REPORTE T√âCNICO</div>
            <div class="text-muted small">
              Folio: <span class="text-danger fw-bold">{{ folio }}</span>
            </div>
          </div>
        </div>
        <div class="d-flex gap-2">
          {% if session.get('role') == 'admin' %}
          <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary btn-sm">Volver al Panel</a>
          {% endif %}
          <a href="{{ url_for('logout') }}" class="btn btn-outline-danger btn-sm">Cerrar Sesi√≥n</a>
        </div>
      </div>
    </div>

    <!-- ‚úÖ id="frm-reporte" necesario para auto-guardado -->
    <form id="frm-reporte" action="{{ url_for('generar_pdf') }}" method="post" enctype="multipart/form-data"
      class="card p-4 mb-5">
      <input type="hidden" name="folio" value="{{ folio }}">
      <input type="hidden" name="tecnico" value="{{ session.get('user_nombre','') }}">

      <!-- Fecha + Localidad -->
      <div class="row g-3 mb-3">
        <div class="col-12 col-sm-4">
          <label class="form-label fw-bold">Fecha</label>
          <input type="date" class="form-control" name="fecha" required>
        </div>
        <div class="col-12 col-sm-4">
          <label class="form-label fw-bold">Localidad</label>
          <select class="form-select" name="localidad" required>
            <option value="Mexicali">Mexicali</option>
            <option value="Tijuana">Tijuana</option>
          </select>
        </div>
      </div>

      <!-- Datos del cliente -->
      <div class="mb-4">
        <div class="section-title mb-2">Datos del cliente</div>
        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label class="form-label">Cliente</label>
            <div class="input-group">
              <select class="form-select" id="cliente_select" name="cliente_select">
                <option value="">Seleccione un cliente...</option>
              </select>
              <button class="btn btn-outline-secondary" type="button" id="toggle_manual_client" title="Entrada Manual">
                ‚úèÔ∏è
              </button>
            </div>
            <input class="form-control mt-2" name="cliente" id="cliente_input" style="display:none;"
              placeholder="Escriba el nombre del cliente">

            <!-- Hidden field to store client ID for logic -->
            <input type="hidden" id="cliente_id">
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label">Contacto</label>
            <div class="input-group">
              <input class="form-control" name="contacto" id="contacto" readonly>
              <button class="btn btn-outline-secondary" type="button" id="toggle_contacto"
                onClick="toggleReadOnly('contacto')" title="Editar">
                üîí
              </button>
            </div>
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label">Tel√©fono</label>
            <div class="input-group">
              <input class="form-control" name="telefono" id="telefono" readonly>
              <button class="btn btn-outline-secondary" type="button" id="toggle_telefono"
                onClick="toggleReadOnly('telefono')" title="Editar">
                üîí
              </button>
            </div>
          </div>
          <div class="col-12 col-md-8">
            <label class="form-label">Email</label>
            <div class="input-group">
              <input class="form-control" name="email" id="email" readonly>
              <button class="btn btn-outline-secondary" type="button" id="toggle_email"
                onClick="toggleReadOnly('email')" title="Editar">
                üîí
              </button>
            </div>
          </div>
          <div class="col-12">
            <label class="form-label">Direcci√≥n</label>
            <div class="input-group">
              <input class="form-control" name="direccion" id="direccion" readonly>
              <button class="btn btn-outline-secondary" type="button" id="toggle_direccion"
                onClick="toggleReadOnly('direccion')" title="Editar">
                üîí
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Servicio -->
      <div class="mb-4">
        <div class="section-title mb-2">Servicio</div>
        <div class="row g-3">
          <div class="col-12 col-md-4">
            <label class="form-label">Tipo de servicio</label>
            <select class="form-select" name="tipo_servicio" id="tipo_servicio">
              <option>Preventivo</option>
              <option>Correctivo</option>
              <option>Diagn√≥stico</option>
              <option>Revisi√≥n</option>
              <option>Bit√°cora</option>
            </select>
          </div>
          <div class="col-12 col-md-8">
            <label class="form-label">Descripci√≥n del servicio</label>
            <select class="form-select" name="descripcion_servicio" id="descripcion_servicio"></select>
            <div class="form-text">Se precarga seg√∫n el tipo de servicio.</div>
          </div>
        </div>
      </div>

      <!-- Equipo -->
      <div class="mb-4">
        <div class="section-title mb-2">Datos del equipo</div>
        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label class="form-label">Tipo de equipo</label>
            <div class="input-group">
              <select class="form-select" id="tipo_equipo_select">
                <option value="">Seleccione tipo de equipo...</option>
                {% for eq in lista_equipos %}
                <option value="{{ eq }}">{{ eq }}</option>
                {% endfor %}
              </select>
              <input class="form-control" name="tipo_equipo" id="tipo_equipo_input" style="display:none;"
                placeholder="Escriba el tipo de equipo" disabled>
              <button class="btn btn-outline-secondary" type="button" id="toggle_tipo_equipo" title="Entrada Manual">
                ‚úèÔ∏è
              </button>
            </div>
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label">Modelo</label>
            <div class="input-group">
              <select class="form-select" id="modelo_select">
                <option value="">Seleccione modelo...</option>
              </select>
              <input class="form-control" name="modelo" id="modelo_input" style="display:none;"
                placeholder="Escriba el modelo" disabled>
              <button class="btn btn-outline-secondary" type="button" id="toggle_modelo" title="Entrada Manual">
                ‚úèÔ∏è
              </button>
            </div>
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label">Serie</label>
            <div class="input-group">
              <input class="form-control" name="serie" id="serie_input" placeholder="Escriba la serie">
              <select class="form-select" id="serie_select" style="display:none;" disabled>
                <option value="">Seleccione serie...</option>
              </select>
              <button class="btn btn-outline-secondary" type="button" id="toggle_serie_manual" title="Entrada Manual">
                ‚úèÔ∏è
              </button>
            </div>
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label">Marca</label>
            <select class="form-select" name="marca" id="marca_select">
              <option value="INGERSOLL RAND">Ingersoll Rand</option>
              <option value="ATLAS COPCO">Atlas Copco</option>
              <option value="QUINCY">Quincy</option>
              <option value="OTROS">OTROS</option>
            </select>
            <div id="otra_marca_wrap" class="mt-2" style="display:none;">
              <input class="form-control" type="text" name="otra_marca" placeholder="Escribe la marca">
            </div>
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label">Potencia</label>
            <input class="form-control" name="potencia" placeholder="Ej. 200">
            <div class="form-text">
              En el PDF saldr√° como <span id="potencia_unidad_hint">‚ÄúHP‚Äù</span>.
            </div>
          </div>
        </div>
      </div>

      <!-- Preventivo -->
      <div id="bloque_preventivo" class="mb-4">
        <div class="section-title mb-2">Actividades (Preventivo)</div>
        <div class="row row-cols-1 row-cols-md-2 g-2">
          {% set acts = [
          "Cambio de filtro de aire","Cambio de filtro de aceite","Cambio de elemento separador",
          "Cambio de filtro panel control","Recuperar nivel de aceite","Cambio de aceite",
          "Cambio de mangueras","Cambio v√°lvula de desfogue","Cambio v√°lvula check descarga",
          "Cambio kit v√°lvula mpcv","Cambio kit, v√°lvula admisi√≥n","Cambio v√°lvula paro de aceite",
          "Cambio kit, val. termocontrol","Cambio de bandas","Reapretar conexiones mec√°nicas",
          "Reapretar conexiones el√©ctricas","Limpieza l√≠nea de barrido","Limpieza trampa de condensados",
          "Limpieza a enfriadores aire/aceite","Revisar funcionamiento de v√°lvulas",
          "Limpieza a platinos de contactores","Lubricaci√≥n rodamiento de motor",
          "Servicio a motor el√©ctrico","Limpieza general del equipo",
          "Toma de muestra de aceite para an√°lisis"
          ] %}
          {% for a in acts %}
          <div class="col">
            <label class="form-check">
              <input class="form-check-input" type="checkbox" name="act_{{ loop.index }}" value="1">
              <span class="form-check-label">{{ a }}</span>
            </label>
          </div>
          {% endfor %}
          <div class="col-12 mt-2">
            <label class="form-label">OTRAS ACTIVIDADES</label>
            <textarea class="form-control" name="act_otras" rows="2" placeholder="Escribe aqu√≠..."></textarea>
          </div>
        </div>

        <div class="mt-3">
          <label class="form-check">
            <input class="form-check-input" type="checkbox" name="act_analisis_ruido" id="chk_ruido" value="1">
            <span class="form-check-label fw-bold">AN√ÅLISIS DE RUIDOS EN RODAMIENTOS</span>
          </label>
          <div class="row g-2 mt-1" id="ruido_opts" style="display:none;">
            <div class="col-12 col-md-3">
              <select class="form-select" name="ruido_tipo" id="ruido_tipo">
                <option value="R30">R30</option>
                <option value="SPM">SPM</option>
              </select>
            </div>
            <div class="col-12 col-md-9" id="ruido_r30" style="display:none;">
              <div class="row g-2">
                <div class="col-md-4"><input class="form-control" name="ruido_resultado" placeholder="Resultado"></div>
                <div class="col-md-8"><input class="form-control" name="ruido_observaciones"
                    placeholder="Observaciones"></div>
              </div>
            </div>
          </div>

          <div id="spm_grid" class="table-responsive mt-3" style="display:none;">
            <table class="table table-bordered table-sm align-middle">
              <thead class="table-light">
                <tr>
                  <th style="min-width:220px">AN√ÅLISIS DE RUIDO EN RODAMIENTOS (SPM)</th>
                  <th>MBRG</th>
                  <th>BG</th>
                  <th>LPMI-MRI</th>
                  <th>LPM2-MR2</th>
                  <th>HPM1</th>
                  <th>HPM2</th>
                  <th>HPF1</th>
                  <th>HPF2</th>
                  <th>LPF1</th>
                  <th>LPF2</th>
                </tr>
              </thead>
              <tbody>
                {% set spm_rows = [
                ("CARGA dBm","carga_dbm"),
                ("CARGA dBc","carga_dbc"),
                ("CARGA dBi","carga_dbi"),
                ("DESCARGA dbm","descarga_dbm"),
                ("DESCARGA dBc","descarga_dbc"),
                ("DESCARGA dBi","descarga_dbi")
                ] %}
                {% for row_lbl, row_key in spm_rows %}
                <tr>
                  <th class="fw-bold">{{ row_lbl }}</th>
                  {% for col in ["mbrg","bg","lpmi_mri","lpm2_mr2","hpm1","hpm2","hpf1","hpf2","lpf1","lpf2"] %}
                  <td><input class="form-control form-control-sm" name="{{ row_key }}_{{ col }}" placeholder="N/A"></td>
                  {% endfor %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ==========================
         Actividades (Preventivo ‚Äì Secador)
         Solo se mostrar√° v√≠a JS cuando:
         - tipo_servicio = Preventivo
         - tipo_equipo contiene "Secador"
         ========================== -->
      <div id="bloque_preventivo_secador" class="mb-4" style="display:none;">
        <div class="section-title mb-2">Actividades (Preventivo ‚Äì Secador)</div>

        <div class="row">
          <div class="col-12 col-md-6">
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="act_sec_rev_general" name="act_sec_rev_general"
                value="1">
              <label class="form-check-label" for="act_sec_rev_general">
                Revisi√≥n general del equipo
              </label>
            </div>

            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="act_sec_reapriete_electrico"
                name="act_sec_reapriete_electrico" value="1">
              <label class="form-check-label" for="act_sec_reapriete_electrico">
                Reapriete de conexiones el√©ctricas
              </label>
            </div>

            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="act_sec_reapriete_mecanico"
                name="act_sec_reapriete_mecanico" value="1">
              <label class="form-check-label" for="act_sec_reapriete_mecanico">
                Reapriete de conexiones mec√°nicas
              </label>
            </div>

            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="act_sec_limpieza_general"
                name="act_sec_limpieza_general" value="1">
              <label class="form-check-label" for="act_sec_limpieza_general">
                Limpieza general del equipo
              </label>
            </div>
          </div>

          <div class="col-12 col-md-6">
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="act_sec_cambio_prefiltro"
                name="act_sec_cambio_prefiltro" value="1">
              <label class="form-check-label" for="act_sec_cambio_prefiltro">
                Cambio de prefiltro
              </label>
            </div>

            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="act_sec_cambio_posfiltro"
                name="act_sec_cambio_posfiltro" value="1">
              <label class="form-check-label" for="act_sec_cambio_posfiltro">
                Cambio de pos filtro
              </label>
            </div>

            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="act_sec_cambio_valvulas"
                name="act_sec_cambio_valvulas" value="1">
              <label class="form-check-label" for="act_sec_cambio_valvulas">
                Cambio de v√°lvulas
              </label>
            </div>
          </div>
        </div>

        <div class="mt-3">
          <label class="form-label">OTRAS ACTIVIDADES</label>
          <textarea class="form-control" name="otras_actividades_secador" rows="3"
            placeholder="Escribe aqu√≠..."></textarea>
        </div>
      </div>

      <!-- Correctivo / Diagn√≥stico / Revisi√≥n -->
      <div id="bloque_correctivo" class="mb-4" style="display:none;">
        <div class="section-title mb-2">Detalle del servicio</div>
        <div class="row g-3">
          <div class="col-12"><label class="form-label">Diagn√≥stico del problema</label><textarea class="form-control"
              name="diag_problema" rows="2"></textarea></div>
          <div class="col-12"><label class="form-label">Causa ra√≠z</label><textarea class="form-control"
              name="causa_raiz" rows="2"></textarea></div>
          <div class="col-12"><label class="form-label">Actividades realizadas</label><textarea class="form-control"
              name="actividades_realizadas" rows="2"></textarea></div>
          <div class="col-12"><label class="form-label">Refacciones utilizadas</label><textarea class="form-control"
              name="refacciones" rows="2"></textarea></div>
          <div class="col-12"><label class="form-label">Condiciones en que se encontr√≥ el equipo</label><textarea
              class="form-control" name="cond_encontro" rows="2"></textarea></div>
          <div class="col-12"><label class="form-label">Condiciones en que se entrega el equipo</label><textarea
              class="form-control" name="cond_entrega" rows="2"></textarea></div>
        </div>
      </div>

      <!-- LECTURAS DEL EQUIPO -->
      <div class="mb-4">
        <div class="section-title mb-2">Lecturas del equipo</div>

        <!-- Lecturas ¬∑ COMPRESOR (vista normal) -->
        <div class="card shadow-sm border-0 mb-4" id="card_lecturas_compresor">
          <div class="row g-4">
            <!-- Datos generales -->
            <div class="col-12 col-lg-6">
              <div class="card p-3">
                <div class="fw-bold mb-2">Datos generales</div>

                <!-- 1 -->
                <div class="row align-items-center mb-2">
                  <div class="col-8 small">Horas totales</div>
                  <div class="col-4 d-flex gap-2">
                    <input class="form-control form-control-sm" name="dg_1">
                    <select class="form-select form-select-sm unidad-select" data-tipo="horas"
                      name="dg_1_unit"></select>
                  </div>
                </div>
                <!-- 2 -->
                <div class="row align-items-center mb-2">
                  <div class="col-8 small">Horas de carga</div>
                  <div class="col-4 d-flex gap-2">
                    <input class="form-control form-control-sm" name="dg_2">
                    <select class="form-select form-select-sm unidad-select" data-tipo="horas"
                      name="dg_2_unit"></select>
                  </div>
                </div>
                <!-- 3 -->
                <div class="row align-items-center mb-2">
                  <div class="col-8 small">Presi√≥n objetivo/descarga</div>
                  <div class="col-4 d-flex gap-2">
                    <input class="form-control form-control-sm" name="dg_3">
                    <select class="form-select form-select-sm unidad-select" data-tipo="presion"
                      name="dg_3_unit"></select>
                  </div>
                </div>
                <!-- 4 -->
                <div class="row align-items-center mb-2">
                  <div class="col-8 small">Presi√≥n de carga</div>
                  <div class="col-4 d-flex gap-2">
                    <input class="form-control form-control-sm" name="dg_4">
                    <select class="form-select form-select-sm unidad-select" data-tipo="presion"
                      name="dg_4_unit"></select>
                  </div>
                </div>
                <!-- 5 -->
                <div class="row align-items-center mb-2">
                  <div class="col-8 small">Presi√≥n descarga del paquete</div>
                  <div class="col-4 d-flex gap-2">
                    <input class="form-control form-control-sm" name="dg_5">
                    <select class="form-select form-select-sm unidad-select" data-tipo="presion"
                      name="dg_5_unit"></select>
                  </div>
                </div>
                <!-- 6 -->
                <div class="row align-items-center mb-2">
                  <div class="col-8 small">Temperatura ambiente</div>
                  <div class="col-4 d-flex gap-2">
                    <input class="form-control form-control-sm" name="dg_6">
                    <select class="form-select form-select-sm unidad-select" data-tipo="temp" name="dg_6_unit"></select>
                  </div>
                </div>
                <!-- 7 -->
                <div class="row align-items-center mb-2">
                  <div class="col-8 small">Temp. descarga del paquete</div>
                  <div class="col-4 d-flex gap-2">
                    <input class="form-control form-control-sm" name="dg_7">
                    <select class="form-select form-select-sm unidad-select" data-tipo="temp" name="dg_7_unit"></select>
                  </div>
                </div>
                <!-- 8 -->
                <div class="row align-items-center mb-2">
                  <div class="col-8 small">Temp. descarga del aire-end</div>
                  <div class="col-4 d-flex gap-2">
                    <input class="form-control form-control-sm" name="dg_8">
                    <select class="form-select form-select-sm unidad-select" data-tipo="temp" name="dg_8_unit"></select>
                  </div>
                </div>
                <!-- 9 -->
                <div class="row align-items-center mb-2">
                  <div class="col-8 small">Temp. inyecci√≥n de refrigerante</div>
                  <div class="col-4 d-flex gap-2">
                    <input class="form-control form-control-sm" name="dg_9">
                    <select class="form-select form-select-sm unidad-select" data-tipo="temp" name="dg_9_unit"></select>
                  </div>
                </div>
                <!-- 10 -->
                <div class="row align-items-center">
                  <div class="col-8 small">Ca√≠da de presi√≥n separador</div>
                  <div class="col-4 d-flex gap-2">
                    <input class="form-control form-control-sm" name="dg_10">
                    <select class="form-select form-select-sm unidad-select" data-tipo="presion"
                      name="dg_10_unit"></select>
                  </div>
                </div>
              </div>
            </div>

            <!-- OIL FREE -->
            <div class="col-12 col-lg-6">
              <div class="card p-3" id="card_oilfree" style="display:none;">
                <div class="fw-bold mb-2">Compresor (oil free)</div>

                <div class="row align-items-center mb-2">
                  <div class="col-8 small">Temp. entrada aire 1ra etapa</div>
                  <div class="col-4 d-flex gap-2">
                    <input class="form-control form-control-sm" name="of_1">
                    <select class="form-select form-select-sm unidad-select" data-tipo="temp" name="of_1_unit"></select>
                  </div>
                </div>
                <div class="row align-items-center mb-2">
                  <div class="col-8 small">Temp. descarga aire 1ra etapa</div>
                  <div class="col-4 d-flex gap-2">
                    <input class="form-control form-control-sm" name="of_2">
                    <select class="form-select form-select-sm unidad-select" data-tipo="temp" name="of_2_unit"></select>
                  </div>
                </div>
                <div class="row align-items-center mb-2">
                  <div class="col-8 small">Presi√≥n descarga 1ra etapa</div>
                  <div class="col-4 d-flex gap-2">
                    <input class="form-control form-control-sm" name="of_3">
                    <select class="form-select form-select-sm unidad-select" data-tipo="presion"
                      name="of_3_unit"></select>
                  </div>
                </div>
                <div class="row align-items-center mb-2">
                  <div class="col-8 small">Temp. entrada 2da etapa</div>
                  <div class="col-4 d-flex gap-2">
                    <input class="form-control form-control-sm" name="of_4">
                    <select class="form-select form-select-sm unidad-select" data-tipo="temp" name="of_4_unit"></select>
                  </div>
                </div>
                <div class="row align-items-center mb-2">
                  <div class="col-8 small">Temp. descarga 2da etapa</div>
                  <div class="col-4 d-flex gap-2">
                    <input class="form-control form-control-sm" name="of_5">
                    <select class="form-select form-select-sm unidad-select" data-tipo="temp" name="of_5_unit"></select>
                  </div>
                </div>
                <div class="row align-items-center mb-2">
                  <div class="col-8 small">Presi√≥n descarga 2da etapa</div>
                  <div class="col-4 d-flex gap-2">
                    <input class="form-control form-control-sm" name="of_6">
                    <select class="form-select form-select-sm unidad-select" data-tipo="presion"
                      name="of_6_unit"></select>
                  </div>
                </div>
                <div class="row align-items-center mb-2">
                  <div class="col-8 small">Temperatura del aceite</div>
                  <div class="col-4 d-flex gap-2">
                    <input class="form-control form-control-sm" name="of_7">
                    <select class="form-select form-select-sm unidad-select" data-tipo="temp" name="of_7_unit"></select>
                  </div>
                </div>
                <div class="row align-items-center mb-2">
                  <div class="col-8 small">Presi√≥n de aceite</div>
                  <div class="col-4 d-flex gap-2">
                    <input class="form-control form-control-sm" name="of_8">
                    <select class="form-select form-select-sm unidad-select" data-tipo="presion"
                      name="of_8_unit"></select>
                  </div>
                </div>
                <div class="row align-items-center mb-2">
                  <div class="col-8 small">Vac√≠o de entrada</div>
                  <div class="col-4 d-flex gap-2">
                    <input class="form-control form-control-sm" name="of_9">
                    <select class="form-select form-select-sm unidad-select" data-tipo="presion"
                      name="of_9_unit"></select>
                  </div>
                </div>
                <div class="row align-items-center">
                  <div class="col-8 small">(otro)</div>
                  <div class="col-4 d-flex gap-2">
                    <input class="form-control form-control-sm" name="of_10">
                    <select class="form-select form-select-sm unidad-select" name="of_10_unit">
                      <option value="">‚Äî</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Lecturas ¬∑ SECADOR -->
        <div class="card shadow-sm border-0 p-3 mb-4" id="card_lecturas_secador" style="display:none;">
          <div class="row g-3">
            <!-- Temperatura de aire de entrada -->
            <div class="col-12 col-md-6 d-flex align-items-center">
              <div class="me-2 flex-grow-1">
                <label class="form-label mb-0">Temperatura de aire de entrada</label>
              </div>
              <div class="me-2" style="width:120px;">
                <input class="form-control form-control-sm" name="sec_temp_aire_entrada">
              </div>
              <div style="width:90px;">
                <select class="form-select form-select-sm unidad-select" name="sec_temp_aire_entrada_u"
                  data-tipo="temp"></select>
              </div>
            </div>

            <!-- Temperatura de aire de salida -->
            <div class="col-12 col-md-6 d-flex align-items-center">
              <div class="me-2 flex-grow-1">
                <label class="form-label mb-0">Temperatura de aire de salida</label>
              </div>
              <div class="me-2" style="width:120px;">
                <input class="form-control form-control-sm" name="sec_temp_aire_salida">
              </div>
              <div style="width:90px;">
                <select class="form-select form-select-sm unidad-select" name="sec_temp_aire_salida_u"
                  data-tipo="temp"></select>
              </div>
            </div>

            <!-- Temperatura del calentador -->
            <div class="col-12 col-md-6 d-flex align-items-center">
              <div class="me-2 flex-grow-1">
                <label class="form-label mb-0">Temperatura del calentador</label>
              </div>
              <div class="me-2" style="width:120px;">
                <input class="form-control form-control-sm" name="sec_temp_calentador">
              </div>
              <div style="width:90px;">
                <select class="form-select form-select-sm unidad-select" name="sec_temp_calentador_u"
                  data-tipo="temp"></select>
              </div>
            </div>

            <!-- Temperatura ambiente -->
            <div class="col-12 col-md-6 d-flex align-items-center">
              <div class="me-2 flex-grow-1">
                <label class="form-label mb-0">Temperatura ambiente</label>
              </div>
              <div class="me-2" style="width:120px;">
                <input class="form-control form-control-sm" name="sec_temp_ambiente">
              </div>
              <div style="width:90px;">
                <select class="form-select form-select-sm unidad-select" name="sec_temp_ambiente_u"
                  data-tipo="temp"></select>
              </div>
            </div>

            <!-- Punto de roc√≠o -->
            <div class="col-12 col-md-6 d-flex align-items-center">
              <div class="me-2 flex-grow-1">
                <label class="form-label mb-0">Punto de roc√≠o</label>
              </div>
              <div class="me-2" style="width:120px;">
                <input class="form-control form-control-sm" name="sec_punto_rocio">
              </div>
              <div style="width:90px;">
                <select class="form-select form-select-sm unidad-select" name="sec_punto_rocio_u"
                  data-tipo="temp"></select>
              </div>
            </div>

            <!-- Tiempo de ciclo -->
            <div class="col-12 col-md-6 d-flex align-items-center">
              <div class="me-2 flex-grow-1">
                <label class="form-label mb-0">Tiempo de ciclo</label>
              </div>
              <div class="me-2" style="width:120px;">
                <input class="form-control form-control-sm" name="sec_tiempo_ciclo" placeholder="Ej. 5 min">
              </div>
              <div style="width:90px;"></div>
            </div>

            <!-- Horas totales -->
            <div class="col-12 col-md-6 d-flex align-items-center">
              <div class="me-2 flex-grow-1">
                <label class="form-label mb-0">Horas totales</label>
              </div>
              <div class="me-2" style="width:120px;">
                <input class="form-control form-control-sm" name="sec_horas_totales">
              </div>
              <div style="width:90px;">
                <select class="form-select form-select-sm unidad-select" name="sec_horas_totales_u"
                  data-tipo="horas"></select>
              </div>
            </div>
          </div>

          <hr class="my-4">

          <div class="row g-3">
            <div class="col-12 col-md-6">
              <label class="form-label">Condiciones de prefiltro</label>
              <textarea class="form-control" name="sec_condicion_prefiltro" rows="2"
                placeholder="Ej. Limpio / saturado / reemplazado..."></textarea>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Condiciones de pos filtro</label>
              <textarea class="form-control" name="sec_condicion_posfiltro" rows="2"
                placeholder="Ej. Limpio / saturado / reemplazado..."></textarea>
            </div>
          </div>
        </div>

        <!-- Datos el√©ctricos ¬∑ COMPRESOR (vista normal) -->
        <div class="card p-3 mt-3" id="card_electrico_compresor">
          <div class="fw-bold mb-2">Datos el√©ctricos</div>
          <div class="table-responsive">
            <table class="table table-bordered table-sm align-middle">
              <thead class="table-light">
                <tr>
                  <th>MEDICI√ìN</th>
                  <th class="text-center">L1 / L1-2</th>
                  <th class="text-center">L2 / L2-3</th>
                  <th class="text-center">L3 / L3-1</th>
                </tr>
              </thead>
              <tbody>
                {% for titulo, key in e3 %}
                <tr>
                  <th>{{ titulo }}</th>
                  {% if key in ['v_carga','v_descarga'] %}
                  <td>
                    <div class="d-flex gap-2">
                      <input class="form-control form-control-sm" name="{{ key }}_l12">
                      <select class="form-select form-select-sm unidad-select" style="width: 80px;"
                        name="{{ key }}_unit"
                        data-tipo="{% if 'Voltaje' in titulo %}voltaje{% elif 'Frecuencia' in titulo %}frecuencia{% else %}general{% endif %}"></select>
                    </div>
                  </td>
                  <td>
                    <div class="d-flex gap-2">
                      <input class="form-control form-control-sm" name="{{ key }}_l23" style="flex: 1;">
                      <select class="form-select form-select-sm unidad-select" style="width: 70px; flex-shrink: 0;"
                        name="{{ key }}_unit_l23"
                        data-tipo="{% if 'Voltaje' in titulo %}voltaje{% elif 'Frecuencia' in titulo %}frecuencia{% else %}general{% endif %}"></select>
                    </div>
                  </td>
                  <td>
                    <div class="d-flex gap-2">
                      <input class="form-control form-control-sm" name="{{ key }}_l31" style="flex: 1;">
                      <select class="form-select form-select-sm unidad-select" style="width: 70px; flex-shrink: 0;"
                        name="{{ key }}_unit_l31"
                        data-tipo="{% if 'Voltaje' in titulo %}voltaje{% elif 'Frecuencia' in titulo %}frecuencia{% else %}general{% endif %}"></select>
                    </div>
                  </td>
                  {% else %}
                  <td>
                    <div class="d-flex gap-2">
                      <input class="form-control form-control-sm" name="{{ key }}_l1">
                      <select class="form-select form-select-sm unidad-select" style="width: 80px;"
                        name="{{ key }}_unit"
                        data-tipo="{% if 'Corriente' in titulo %}amperaje{% elif 'Potencia' in titulo %}potencia{% else %}general{% endif %}"></select>
                    </div>
                  </td>
                  <td>
                    <div class="d-flex gap-2">
                      <input class="form-control form-control-sm" name="{{ key }}_l2" style="flex: 1;">
                      <select class="form-select form-select-sm unidad-select" style="width: 70px; flex-shrink: 0;"
                        name="{{ key }}_unit_l2"
                        data-tipo="{% if 'Corriente' in titulo %}amperaje{% elif 'Potencia' in titulo %}potencia{% else %}general{% endif %}"></select>
                    </div>
                  </td>
                  <td>
                    <div class="d-flex gap-2">
                      <input class="form-control form-control-sm" name="{{ key }}_l3" style="flex: 1;">
                      <select class="form-select form-select-sm unidad-select" style="width: 70px; flex-shrink: 0;"
                        name="{{ key }}_unit_l3"
                        data-tipo="{% if 'Corriente' in titulo %}amperaje{% elif 'Potencia' in titulo %}potencia{% else %}general{% endif %}"></select>
                    </div>
                  </td>
                  {% endif %}
                </tr>
                {% endfor %}
                {% for titulo, key in e1 %}
                <tr>
                  <th>{{ titulo }}</th>
                  <td colspan="3">
                    <div class="d-flex gap-2" style="max-width: 300px;">
                      <input class="form-control form-control-sm" name="{{ key }}">
                      <select class="form-select form-select-sm unidad-select" style="width: 90px;"
                        name="{{ key }}_unit"
                        data-tipo="{% if 'Temperatura' in titulo %}temp{% elif 'RPM' in titulo %}rpm{% else %}general{% endif %}"></select>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Datos el√©ctricos ¬∑ SECADOR (solo 6 valores) -->
        <div class="card p-3 mt-3" id="card_electrico_secador" style="display:none;">
          <div class="fw-bold mb-2">Datos el√©ctricos</div>
          <div class="table-responsive">
            <table class="table table-bordered table-sm align-middle">
              <thead class="table-light">
                <tr>
                  <th>MEDICI√ìN</th>
                  <th class="text-center">L1 / L1-2</th>
                  <th class="text-center">L2 / L2-3</th>
                  <th class="text-center">L3 / L3-1</th>
                </tr>
              </thead>
              <tbody>
                <!-- Corriente comp. en carga (L1, L2, L3) -->
                <tr>
                  <th>Corriente comp. en carga</th>
                  <td>
                    <div class="d-flex gap-2">
                      <input class="form-control form-control-sm" name="i_carga_l1">
                      <select class="form-select form-select-sm unidad-select" style="width: 80px;" name="i_carga_unit"
                        data-tipo="amperaje"></select>
                    </div>
                  </td>
                  <td>
                    <div class="d-flex gap-2">
                      <input class="form-control form-control-sm" name="i_carga_l2" style="flex: 1;">
                      <select class="form-select form-select-sm unidad-select" style="width: 70px; flex-shrink: 0;"
                        name="i_carga_unit_l2" data-tipo="amperaje"></select>
                    </div>
                  </td>
                  <td>
                    <div class="d-flex gap-2">
                      <input class="form-control form-control-sm" name="i_carga_l3" style="flex: 1;">
                      <select class="form-select form-select-sm unidad-select" style="width: 70px; flex-shrink: 0;"
                        name="i_carga_unit_l3" data-tipo="amperaje"></select>
                    </div>
                  </td>
                </tr>

                <!-- Voltaje comp. en carga (L1-L2, L2-L3, L1-L3) -->
                <tr>
                  <th>Voltaje comp. en carga</th>
                  <td>
                    <div class="d-flex gap-2">
                      <input class="form-control form-control-sm" name="v_carga_l12">
                      <select class="form-select form-select-sm unidad-select" style="width: 80px;" name="v_carga_unit"
                        data-tipo="voltaje"></select>
                    </div>
                  </td>
                  <td>
                    <div class="d-flex gap-2">
                      <input class="form-control form-control-sm" name="v_carga_l23" style="flex: 1;">
                      <select class="form-select form-select-sm unidad-select" style="width: 70px; flex-shrink: 0;"
                        name="v_carga_unit_l23" data-tipo="voltaje"></select>
                    </div>
                  </td>
                  <td>
                    <div class="d-flex gap-2">
                      <input class="form-control form-control-sm" name="v_carga_l31" style="flex: 1;">
                      <select class="form-select form-select-sm unidad-select" style="width: 70px; flex-shrink: 0;"
                        name="v_carga_unit_l31" data-tipo="voltaje"></select>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>


      <!-- Observaciones -->
      <div class="mb-4">
        <div class="section-title mb-2">Observaciones y recomendaciones</div>
        <textarea class="form-control" name="observaciones" rows="3"></textarea>
      </div>

      <!-- Fotos -->
      <div class="mb-4">
        <div class="section-title mb-2">Evidencias fotogr√°ficas <span id="fotos_hint">(m√°x. 4)</span></div>
        <div class="row g-3" id="fotos_grid">
          {% for i in range(1,5) %}
          <div class="col-12 col-md-6 foto-item" data-index="{{ i }}">
            <div class="form-text mb-1">Foto {{ i }}</div>
            <!-- Preview container -->
            <div id="foto{{i}}_preview_container" class="mb-2" style="display:none; position:relative;">
              <img id="foto{{i}}_preview" src="" alt="Preview"
                style="max-width:100%; max-height:200px; border-radius:4px; border:1px solid #ddd;">
              <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1"
                onclick="removePhoto({{i}})">√ó</button>
            </div>

            <input class="form-control" type="file" accept="image/*" name="foto{{i}}" id="foto{{i}}_input"
              onchange="previewPhoto(this, {{i}})">
            <input type="hidden" name="foto{{i}}_existing" id="foto{{i}}_existing">
            <!-- NEW: Hidden input for auto-save (Base64 data) -->
            <input type="hidden" name="foto{{i}}_data" id="foto{{i}}_data">
            <input class="form-control mt-2" name="foto{{i}}_desc" placeholder="Descripci√≥n">
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Firmas -->
      <div class="mb-4">
        <div class="section-title mb-2">Firmas</div>
        <div class="row g-3">
          <div class="col-12 col-md-6">
            <div class="sig-box p-2">
              <canvas id="firma_tecnico_canvas" style="width:100%; height:120px;"></canvas>
            </div>
            <div class="mt-2 d-flex gap-2">
              <input class="form-control" name="firma_tecnico_nombre" placeholder="Nombre del t√©cnico">
              <button type="button" id="btn_clear_tecnico" class="btn btn-outline-secondary">Borrar</button>
            </div>
            <input type="hidden" id="firma_tecnico_data" name="firma_tecnico_data">
          </div>
          <div class="col-12 col-md-6">
            <div class="sig-box p-2">
              <canvas id="firma_cliente_canvas" style="width:100%; height:120px;"></canvas>
            </div>
            <div class="mt-2 d-flex gap-2">
              <input class="form-control" name="firma_cliente_nombre" placeholder="Nombre del cliente">
              <button type="button" id="btn_clear_cliente" class="btn btn-outline-secondary">Borrar</button>
            </div>
            <input type="hidden" id="firma_cliente_data" name="firma_cliente_data">
          </div>
        </div>
      </div>

      <!-- ‚úÖ Bot√≥n para limpiar borrador + Generar PDF -->
      <div class="d-flex justify-content-end gap-2">
        <button type="button" id="btn-clear-draft" class="btn btn-outline-secondary">Borrar borrador</button>
        <button class="btn btn-primary px-4">Generar PDF</button>
      </div>
    </form>
  </div>

  <div class="d-flex flex-wrap gap-2 justify-content-end mt-3">
    <!-- Abre el modal con la lista de borradores -->
    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalBorradores">
      Ver borradores
    </button>

    <!-- Crea un folio nuevo y limpia -->
    <form action="{{ url_for('nuevo_folio') }}" method="post" class="d-inline">
      <button class="btn btn-outline-secondary" type="submit">Nuevo reporte</button>
    </form>
  </div>

  <!-- Exponemos el folio para el JS (auto-guardado/borradores) -->
  <script>
    window.__FOLIO__ = "{{ folio }}";
  </script>

  <!-- Modal: Borradores guardados en este dispositivo -->
  <div class="modal fade" id="modalBorradores" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Borradores en este dispositivo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div id="lista-borradores" class="list-group small"></div>
          <div class="text-muted mt-3">Nota: los borradores se guardan en este navegador y este dispositivo.</div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS (necesario para el modal) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Global functions for photo preview (kept here for simplicity) -->
  <script>
    function previewPhoto(input, index) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const previewContainer = document.getElementById(`foto${index}_preview_container`);
          const previewImg = document.getElementById(`foto${index}_preview`);
          const hiddenData = document.getElementById(`foto${index}_data`);

          if (previewContainer && previewImg) {
            previewImg.src = e.target.result;
            previewContainer.style.display = 'block';
            input.style.display = 'none';
          }
        }
        reader.readAsDataURL(input.files[0]);
      }
    }

    function removePhoto(index) {
      const input = document.getElementById(`foto${index}_input`);
      const previewContainer = document.getElementById(`foto${index}_preview_container`);
      const previewImg = document.getElementById(`foto${index}_preview`);
      const hiddenInput = document.getElementById(`foto${index}_existing`);
      const hiddenData = document.getElementById(`foto${index}_data`);

      if (input) {
        input.value = ''; // Clear file input
        input.style.display = 'block';
      }

      if (previewContainer) {
        previewContainer.style.display = 'none';
      }

      if (previewImg) {
        previewImg.src = '';
      }

      if (hiddenInput) {
        hiddenInput.value = ''; // Clear existing data
      }
    }
  </script>

  <!-- Auto-fill equipment from client selection -->
  <script src="{{ url_for('static', filename='js/cliente_autofill.js') }}?v={{ range(1, 10000) | random }}"></script>

  <!-- Tu JS con auto-guardado, SPM/R30, Oil-Free, firmas, etc. -->
  <script src="{{ url_for('static', filename='js/interactividad_v2.js') }}?v={{ range(1, 10000) | random }}"></script>
</body>

</html>